<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <title>Bible Study V.1</title>
</head>
<body>
<div class="left">
    <h5 style="margin:0;width: fit-content;">Bible Version</h5>
    <a title="Raamattu Kansalle" class="translation" onclick="initPage('finRk')">finRK</a>
    <a title="Raamattu 33/38" class="translation" onclick="initPage('fi38')">fi38</a>
</div>

<div class="center">

    <div id="books"></div>
    <div id="chapters"></div>
    <input placeholder="word search" type="text" id="sanahaku" onchange="searchByWord(this.value)">
    <div id="content">
        <div id="contleft" class="contentL">
            <h2><span id="bookName"></span><span id="chapterNumber"></span></h2>
            <div id="text"></div>
        </div>
        <div id="contright" class="contentR">
            <div>
                <a title="save notes" class="savenote" onclick="setKey()"></a>
                <a title="overwrite this document" class="overwrite" onclick="overwrite(localStorage.getItem('notekey'))"></a>
                <a title="load notes" class="loadnote" onclick="setNoteKey()"></a>
                <a title="save notes to PDF" class="topdf" onclick="printToPdf()"></a>
                <a title="clear document" class="clearnote" onclick="clearNotes()"></a>
                <input class="autosave" id="autosave" type="checkbox" onchange="setAutoSave(this.checked)">
                <label for="autosave">auto save</label>
            </div>
            <div id="verse"></div>
            <input placeholder="insert comment" type="text" id="iComment" onchange="addNote(this.value);this.value=''">
        </div>
    </div>

</div>

<script>
var url = "http://miikatoimii.ddns.net/api";
var dHost = location.host;
var autosave = document.getElementById('autosave')


if(localStorage.getItem('ver') == undefined){
    localStorage.setItem('ver', 'finRK')
} else {
    var kVersio = localStorage.getItem('ver');
}

if(localStorage.getItem('notekey') != undefined || localStorage.getItem('notekey') != ""){
    loadNotes(localStorage.getItem('notekey'))
}

if(localStorage.getItem('autosave') != 'true'){
    localStorage.setItem('autosave', 'false')
} else{
    autosave.checked = localStorage.getItem('autosave')
}
function setAutoSave(value){
    localStorage.setItem('autosave', value)
}

function autoSave(){
    if(localStorage.getItem('notekey') != undefined || localStorage.getItem('notekey') != ""){
        if(autosave.checked){
            overwrite(localStorage.getItem('notekey'))
            localStorage.setItem('autosave', true)
        } 
    }
}

function initPage(versio){
    localStorage.setItem('ver', versio);
    kVersio = localStorage.getItem('ver');
    location.reload();
}


function loadDoc() {
    var xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange=function() {
        if (this.readyState == 4 && this.status == 200) {
            let kirjat = JSON.parse(this.responseText);
            document.getElementById('books').innerHTML = "";
            kirjat.forEach(kirja => {
                document.getElementById('books').innerHTML += `<a class="book" title="${kirja.long_name}" onclick='getChapters("${url}/${kVersio}/${kirja.book_number}", "${kirja.short_name}")'>${kirja.short_name}</a>`
            });
            initWindow()
        }
    };
    xhttp.open("GET", url+`?host=${dHost}`, true)
    xhttp.send();
}
loadDoc();
function setThis(value){
    return value;
}
function getChapters(requestUrl, bookname){
    var xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange=function() {
        if (this.readyState == 4 && this.status == 200) {
            let data = JSON.parse(this.responseText);
            console.log(data[0])
            document.getElementById('bookName').innerHTML = bookname;
            document.getElementById('chapterNumber').innerHTML = "";
            document.getElementById('chapters').innerHTML = "";
            document.getElementById('text').innerHTML = "";
            var chpt = 1
            for(var i = 0; i < data.length; i++){
                if(data[i].chapter == chpt){
                    chpt++;
                    document.getElementById('chapters').innerHTML += `<a class="chapter" title="${data[i].chapter}" onclick='getSingleChapter("${url}/${kVersio}/${data[i].book_number}/${data[i].chapter}", "${bookname}")'> ${data[i].chapter}</a>`
                }
                
                    
            }
            initWindow()
        }
    };
    xhttp.open("GET", requestUrl+`?host=${dHost}`, true)
    xhttp.send();
}
function getSingleChapter(requestUrl, bookname){
    var xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange=function() {
        if (this.readyState == 4 && this.status == 200) {
            let data = JSON.parse(this.responseText);

            document.getElementById('bookName').innerHTML = bookname;
            document.getElementById('chapterNumber').innerHTML = " "+data[0].chapter;
            document.getElementById('text').innerHTML = "";

            for(var i = 0; i < data.length; i++){
                document.getElementById('text').innerHTML += `<a onclick=getSingleVerse("${requestUrl}/${data[i].verse}")><p class="onverse">${data[i].verse}. ${data[i].text}</p></a>`
            }
            initWindow()

            
        }
    };
    xhttp.open("GET", requestUrl+`?host=${dHost}`, true)
    xhttp.send();
}
function getSingleVerse(requestUrl){
    var xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange=function() {
        if (this.readyState == 4 && this.status == 200) {
            let data = JSON.parse(this.responseText);
            var noteid = Math.ceil(Math.random()*1000000)+'-idkk'
            document.getElementById('verse').innerHTML += `<p id="${noteid}">${data[0].short_name} ${data[0].chapter}:${data[0].verse} ${data[0].text}<a onclick="deleteNote('${noteid}')">delete</a></p>`
            document.getElementById('verse').scrollTop = document.getElementById('verse').scrollHeight
            autoSave();
            initWindow()
        }
    };
    xhttp.open("GET", requestUrl+`?host=${dHost}`, true)
    xhttp.send();
}

function searchByWord(searchvalue){
    var xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange=function() {
        if (this.readyState == 4 && this.status == 200) {
            let data = JSON.parse(this.responseText);
            document.getElementById('bookName').innerHTML = "";
            document.getElementById('chapterNumber').innerHTML = "";
            document.getElementById('text').innerHTML = "";
            
            for(var i = 0; i < data.length; i++){
                var textNode = `${data[i].short_name} ${data[i].chapter}:${data[i].verse}. ${data[i].text}`
                document.getElementById('text').innerHTML += `<a onclick="addNote('${textNode}')"><p>${data[i].short_name} ${data[i].chapter}:${data[i].verse}. ${data[i].text}</p></a>`
            initWindow()
            }
        }
    };
    xhttp.open("GET", url+`/find?like=${searchvalue}&host=${dHost}`, true)
    xhttp.send();
}
function addNote(nodevalue){
    var aa = document.createElement('a');
    var noteid = Math.ceil(Math.random()*1000000)+'-id'
    aa.setAttribute('onclick', `deleteNote('${noteid}')`)
    aa.innerText = "delete";
    var pp = document.createElement('p');
    pp.setAttribute('id', noteid);
    pp.innerHTML = nodevalue;
    pp.appendChild(aa)
    document.getElementById('verse').appendChild(pp)
    document
    initWindow()
    document.getElementById('verse').scrollTop = document.getElementById('verse').scrollHeight
    autoSave()
}
function clearNotes(){
    document.getElementById('verse').innerHTML = "";
    autoSave()
}
function deleteNote(id){
    document.getElementById(id).style.display = "none";
    autoSave()
}
function saveNotes(secretid){
    var jsonobject = {
        key: secretid,
        notes: document.getElementById('verse').innerHTML
    }
    var json = JSON.stringify(jsonobject);
    localStorage.setItem('notekey', secretid)

    var xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange=function() {
        if (this.readyState == 4 && this.status == 200) {
            alert(`notes have been saved! secret key: ${secretid}`)
            initWindow()
        }
    };
    xhttp.open("GET", url+`/save?file=${json}&host=${dHost}`, true)
    xhttp.send();
}
function overwrite(secretid){
    var jsonobject = {
        key: secretid,
        notes: document.getElementById('verse').innerHTML
    }
    var json = JSON.stringify(jsonobject);
    localStorage.setItem('notekey', secretid)

    var xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange=function() {
        if (this.readyState == 4 && this.status == 200) {
            initWindow()
        }
    };
    xhttp.open("GET", url+`/save?file=${json}&host=${dHost}`, true)
    xhttp.send();
}
function loadNotes(secretkey){
    var xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange=function() {
        if (this.readyState == 4 && this.status == 200) {
            var json = JSON.parse(this.responseText);
            localStorage.setItem('notekey', secretkey)
            document.getElementById('verse').innerHTML = json.notes;
            initWindow()
        }
    };
    xhttp.open("GET", url+`/load?file=${secretkey}&host=${dHost}`, true)
    xhttp.send();
}
function setKey(){
    var storedkey = "";
    if(localStorage.getItem('notekey') != null || localStorage.getItem('notekey') != undefined || localStorage.getItem('notekey') != "")
        storedkey = localStorage.getItem('notekey')
    
    var key = prompt('Please choose note key', storedkey);
    if(key == null){
        return
    }
    if(key != null || key != undefined || key != ""){
        saveNotes(key)
    }
}
function setNoteKey(){
    var storedkey = "";
    if(localStorage.getItem('notekey') != null || localStorage.getItem('notekey') != undefined || localStorage.getItem('notekey') != "")
        storedkey = localStorage.getItem('notekey')

    var key = prompt('Please enter your note key', storedkey);
    if(key == null){
        return
    }
    if(key != null || key != undefined || key != ""){
        loadNotes(key)
    }
}
window.addEventListener('resize',()=>{
    initWindow()
})
var conttt = document.getElementById('content')
function initWindow(){
    document.getElementById('content').style.height = window.innerHeight-document.getElementById('content').offsetTop-10+"px"
}
initWindow()
function printToPdf(){
    var myWindow = window.open("", "", "fullscreen=yes");
    myWindow.document.write(document.getElementById('verse').innerHTML);
    myWindow.print();
    myWindow.close();
}
</script>   
</body>
</html>